---
description: 要件を再確認し、リスクを評価し、段階的な実装計画を作成する。コードに触れる前にユーザーの確認を待つ。
---

# Planコマンド

このコマンドは**planner**エージェントを呼び出し、コード作成前に包括的な実装計画を作成する。

## このコマンドの機能

1. **要件の再確認** - 構築すべきものを明確化
2. **リスクの特定** - 潜在的な問題やブロッカーを洗い出す
3. **ステップ計画の作成** - 実装をフェーズに分解
4. **確認を待つ** - 続行前にユーザーの承認を必ず得る

## 使用タイミング

以下の場合に `/plan` を使用:
- 新機能の開発開始時
- 重要なアーキテクチャ変更時
- 複雑なリファクタリング作業時
- 複数のファイル/コンポーネントに影響がある場合
- 要件が不明確または曖昧な場合

## 動作の仕組み

plannerエージェントが以下を実行:

1. **リクエストを分析** し、要件を明確な言葉で再確認
2. **フェーズに分解** し、具体的で実行可能なステップを提示
3. **依存関係を特定** コンポーネント間の関連を把握
4. **リスクを評価** 潜在的なブロッカーを分析
5. **複雑度を見積もり** （高/中/低）
6. **計画を提示** し、明示的な確認を待つ

## 使用例

```
ユーザー: /plan マーケットが解決された時にリアルタイム通知を追加したい

エージェント（planner）:
# 実装計画: リアルタイムマーケット解決通知

## 要件の再確認
- ウォッチ中のマーケットが解決された時にユーザーに通知を送信
- 複数の通知チャネルをサポート（アプリ内、メール、Webhook）
- 通知が確実に配信されることを保証
- マーケットの結果とユーザーのポジション結果を含める

## 実装フェーズ

### フェーズ1: データベーススキーマ
- 通知テーブルを追加（カラム: id, user_id, market_id, type, status, created_at）
- ユーザー通知設定テーブルをチャネル設定用に追加
- パフォーマンス向上のためuser_idとmarket_idにインデックスを作成

### フェーズ2: 通知サービス
- lib/notifications.tsに通知サービスを作成
- BullMQ/Redisを使用した通知キューを実装
- 配信失敗時のリトライロジックを追加
- 通知テンプレートを作成

### フェーズ3: 統合ポイント
- マーケット解決ロジックにフック（ステータスが"resolved"に変更された時）
- マーケットにポジションを持つ全ユーザーをクエリ
- 各ユーザーへの通知をキューに追加

### フェーズ4: フロントエンドコンポーネント
- ヘッダーにNotificationBellコンポーネントを作成
- NotificationListモーダルを追加
- Supabaseサブスクリプションによるリアルタイム更新を実装
- 通知設定ページを追加

## 依存関係
- Redis（キュー用）
- メールサービス（SendGrid/Resend）
- Supabaseリアルタイムサブスクリプション

## リスク
- HIGH: メール到達率（SPF/DKIMが必要）
- MEDIUM: マーケットあたり1000人以上のユーザーでのパフォーマンス
- MEDIUM: マーケットが頻繁に解決される場合の通知スパム
- LOW: リアルタイムサブスクリプションのオーバーヘッド

## 推定複雑度: MEDIUM
- バックエンド: 4-6時間
- フロントエンド: 3-4時間
- テスト: 2-3時間
- 合計: 9-13時間

**確認待ち**: この計画で進めますか？（yes/no/modify）
```

## 重要な注意事項

**CRITICAL**: plannerエージェントは、"yes"や"proceed"などの肯定的な応答で明示的に計画を確認するまで、**一切コードを書きません**。

変更が必要な場合は以下のように応答:
- "modify: [変更内容]"
- "different approach: [代替案]"
- "フェーズ2をスキップしてフェーズ3を先にやって"

## 他のコマンドとの連携

計画作成後:
- `/tdd` でテスト駆動開発による実装
- `/build-and-fix` でビルドエラーが発生した場合の対応
- `/code-review` で完成した実装のレビュー

## 関連エージェント

このコマンドは以下にある `planner` エージェントを呼び出す:
`~/.claude/agents/planner.md`
